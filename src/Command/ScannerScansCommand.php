<?php

namespace App\Command;

use App\Entity\Asset;
use App\Entity\Status;
use App\Entity\Vulnerability;
use App\Entity\VulnerabilityDetected;
use App\Entity\Detection;
use Symfony\Component\Console\Command\Command;
use Symfony\Bundle\FrameworkBundle\Command\ContainerAwareCommand;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\Serializer\Serializer;
use Symfony\Component\Serializer\Encoder\CsvEncoder;
use Symfony\Component\Serializer\Normalizer\ObjectNormalizer;
use \Datetime;
use Unirest;


class ScannerScansCommand extends ContainerAwareCommand
{
    protected function configure()
    {
        $this
            ->setName('app:ScannerScans')

            ->setDescription('This command get details about scans stored in the scanner')
            ->addArgument('argument', InputArgument::REQUIRED, 'The argument of the scans command')
            ->setHelp('Send the argument to the scans command exposed by the Nessus API of the scanner')
        ;
    }

    /**
     * @param InputInterface $input
     * @param OutputInterface $output
     * @return int|null|void
     */
    protected function execute(InputInterface $input, OutputInterface $output)
    {
        // initializing Container to work with Entities
        $em = $this->getContainer()->get('doctrine')->getManager();
        $em->getConnection()->getConfiguration()->setSQLLogger(null);

        // Connection to the API to retrieve session token
        $output->writeln('We connect to the API');
	$headers = array('Accept' => 'application/json');
	$data = array('username' => getenv('SCANNER_LOGIN'), 'password' => getenv('SCANNER_PASSWORD'));        
	$body = Unirest\Request\Body::form($data);	
	// We disable SSL verification
	Unirest\Request::verifyPeer(false);
	$response = Unirest\Request::post(getenv('SCANNER_SERVER').'/session',$headers,$body);
	$token = $response->body->token;
        if (empty($token)) 
	{
		$output->writeln('Session initialization failed');
	}
	else
	{
		$output->writeln('Session establishment succeed');
	}
	// The token is send in the defaultheader
	Unirest\Request::defaultHeader('X-Cookie', 'token='.$token.'');
	
	// We retrieve the Folder list with the session token
	$response = Unirest\Request::get(getenv('SCANNER_SERVER').'/folders',$headers,'');

	// We export data to csv file
	$serializer = new Serializer([new ObjectNormalizer()], [new CsvEncoder()]);
	$csvData = array(array('Folder', 'ScanName', 'Planification', 'LastExecution', 'Targets', 'NbreTargets'));

	foreach ($response->body->folders as $folder)
	{
		$output->writeln('Folder '.$folder->name.' is processed');	
		$query = array('folder_id' => $folder->id);
		$responseScans = Unirest\Request::get(getenv('SCANNER_SERVER').'/scans',$headers,$query);
		$output->writeln(count($responseScans->body->scans).' scans in this Folder');		
		if (!empty($responseScans->body->scans))
		{
		foreach ($responseScans->body->scans as $scan)
		{
			$query = array('scan_id' => $scan->id);
			$responseScanDetails = Unirest\Request::get(getenv('SCANNER_SERVER').'/scans/'.$scan->id,$headers,$query);		
			if (!empty($responseScanDetails->body->info->hostcount))
			{
			$output->writeln('Nombre de targets dans '.$scan->name. ' = '.$responseScanDetails->body->info->hostcount);
			$csvData[] = array($folder->name, $scan->name, $scan->rrules, 
				date('r',$responseScanDetails->body->info->scan_start),
				$responseScanDetails->body->info->targets, 
				$responseScanDetails->body->info->hostcount);
			}
		}
		}
	}
	file_put_contents(
    	'data.csv',
    	$this->getContainer()->get('serializer')->encode($csvData, 'csv')
	);

	}
}
