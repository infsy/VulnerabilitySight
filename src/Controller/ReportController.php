<?php

namespace App\Controller;

use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Annotation\Route;
use Symfony\Bundle\FrameworkBundle\Controller\Controller;
use Symfony\Component\HttpFoundation\Request;

class ReportController extends Controller
{
    /**
     * @Route("/report/index", name="reportPage")
     */
    public function index()
    {
        $request = Request::createFromGlobals();
        $month = $request->get('month', 1);
        $year = $request->get('year', date("Y"));

        $hosts_high = $this->getDoctrine()
            ->getRepository('App:Asset')
            ->getHostsMajor($month, $year);
        $hosts_critical = $this->getDoctrine()
            ->getRepository('App:Asset')
            ->getHostsCritical($month, $year);
        $detections_high = $this->getDoctrine()
            ->getRepository('App:Detection')
            ->getHighsByDate($month, $year);
        $detections_critical = $this->getDoctrine()
            ->getRepository('App:Detection')
            ->getCriticalsByDate($month, $year);
        $uniques_high = $this->getDoctrine()
            ->getRepository('App:Vulnerability')
            ->getUniqueHighs($month, $year);
        $uniques_critical = $this->getDoctrine()
            ->getRepository('App:Vulnerability')
            ->getUniqueCrits($month, $year);
        $old_high = $this->getDoctrine()
            ->getRepository('App:Vulnerability')
            ->getOldHighs($month, $year);
        $old_critical = $this->getDoctrine()
            ->getRepository('App:Vulnerability')
            ->getOldCrits($month, $year);
        $new_high = $this->getDoctrine()
            ->getRepository('App:Vulnerability')
            ->getNewHighs($month, $year);
        $new_critical = $this->getDoctrine()
            ->getRepository('App:Vulnerability')
            ->getNewCrits($month, $year);

        return $this->render('Report/index.html.twig', array(
            'hosts_high' => $hosts_high,
            'hosts_critical' => $hosts_critical,
            'detections_high' => $detections_high,
            'detections_critical' => $detections_critical,
            'uniques_high' => $uniques_high,
            'uniques_critical' => $uniques_critical,
            'old_high' => $old_high,
            'old_critical' => $old_critical,
            'new_high' => $new_high,
            'new_critical' => $new_critical,
            'month' => $month,
            'year' => $year
        ));
    }
}
