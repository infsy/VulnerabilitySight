<?php

namespace App\Command;

use App\Entity\Asset;
use App\Entity\Status;
use App\Entity\Vulnerability;
use App\Entity\VulnerabilityDetected;
use App\Entity\Detection;
use Symfony\Component\Console\Command\Command;
use Symfony\Bundle\FrameworkBundle\Command\ContainerAwareCommand;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\Serializer\Serializer;
use Symfony\Component\Serializer\Encoder\CsvEncoder;
use Symfony\Component\Serializer\Normalizer\ObjectNormalizer;
use \Datetime;
use Unirest;


class ScannerUpdateDetectionsCommand extends ContainerAwareCommand
{
    protected function configure()
    {
        $this
            ->setName('app:ScannerUpdateDetections')
            ->setDescription('This command synchronize Detections vulnerabilities count from the DB')
            ->setHelp('Get Detections vulnerabilities details from database and update those which are in the detection entity');
    }

    /**
     * @param InputInterface $input
     * @param OutputInterface $output
     * @return int|null|void
     */
    protected function execute(InputInterface $input, OutputInterface $output)
    {
	// initializing Container to work with Entities
        $em = $this->getContainer()->get('doctrine')->getManager();
        $em->getConnection()->getConfiguration()->setSQLLogger(null);

        $detections = $em->getRepository('App:Detection')->findAll();

        foreach ($detections as $detection) {

        $output->writeln('Processing scan '.$detection->getId());
	    $criticals = $em->getRepository('App:Detection')->getCriticalsByScan($detection);
	    $majors = $em->getRepository('App:Detection')->getMajorsByScan($detection);
        //$hosts = $em->getRepository('App:Asset')->getHostsByScan();
		//if ($detection->getId() == 1) {
        print_r("Criticals : " . $criticals . " ");print_r("Medium : " . $majors . " \n\n");
        //print_r("Host... " . $hosts . " ");
        //}
	    $detection->setCritical($criticals);
	    $detection->setMedium($majors);
            $em->persist($detection);
        }
        $em->flush();

   }

}
