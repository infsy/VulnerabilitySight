<?php

namespace App\Controller;

use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Annotation\Route;
use Symfony\Bundle\FrameworkBundle\Controller\Controller;
use Symfony\Component\HttpFoundation\Request;
use CMEN\GoogleChartsBundle\GoogleCharts\Charts\LineChart;

class ReportController extends Controller
{
    /**
     * @Route("/report/index", name="reportPage")
     */
    public function index()
    {
        $request = Request::createFromGlobals();
        $month = $request->get('month', 1);
        $year = $request->get('year', date("Y"));

        $hosts_high = $this->getDoctrine()
            ->getRepository('App:Asset')
            ->getHostsMajor($month, $year);
        $hosts_critical = $this->getDoctrine()
            ->getRepository('App:Asset')
            ->getHostsCritical($month, $year);
        $detections_high = $this->getDoctrine()
            ->getRepository('App:Detection')
            ->getHighsByDate($month, $year);
        $detections_critical = $this->getDoctrine()
            ->getRepository('App:Detection')
            ->getCriticalsByDate($month, $year);
        $uniques_high = $this->getDoctrine()
            ->getRepository('App:Vulnerability')
            ->getUniqueHighs($month, $year);
        $uniques_critical = $this->getDoctrine()
            ->getRepository('App:Vulnerability')
            ->getUniqueCrits($month, $year);
        $old_high = $this->getDoctrine()
            ->getRepository('App:Vulnerability')
            ->getOldHighs($month, $year);
        $old_critical = $this->getDoctrine()
            ->getRepository('App:Vulnerability')
            ->getOldCrits($month, $year);
        $new_high = $this->getDoctrine()
            ->getRepository('App:Vulnerability')
            ->getNewHighs($month, $year);
        $new_critical = $this->getDoctrine()
            ->getRepository('App:Vulnerability')
            ->getNewCrits($month, $year);
        $new_highvd = $this->getDoctrine()
            ->getRepository('App:VulnerabilityDetected')
            ->getNewHighVD($month, $year);
            $new_highvd = count($new_highvd);
        //$new_critvd = $this->getDoctrine()
        //    ->getRepository('App:VulnerabilityDetected')
        //    ->getNewCrits($month, $year);

        $new_critvd = $this->getDoctrine()
            ->getRepository('App:VulnerabilityDetected')
            ->getNewCritVD($month, $year);
            $new_critvd = count($new_critvd);
        $new_openhighvd = $this->getDoctrine()
            ->getRepository('App:VulnerabilityDetected')
            ->getNewHighVDOpened($month, $year);
        $new_opencritvd = $this->getDoctrine()
            ->getRepository('App:VulnerabilityDetected')
            ->getNewCritVDOpened($month, $year);

        $line = new LineChart();
        $line->getData()->setArrayToDataTable(
            [
                ['Month', 'Critical', 'High'],
                ['Jan',  1500,      700],
                ['Feb',  1000,      400],
                ['March',  1170,      460],
                ['April',  660,       1120],
                ['May',  1030,      540]
            ]);
        $line->getOptions()->setTitle('Vulnerabilities by month');
        $line->getOptions()->setCurveType('function');
        $line->getOptions()->setLineWidth(4);
        $line->getOptions()->setHeight(500);
        $line->getOptions()->setWidth(1200);
        $line->getOptions()->getLegend()->setPosition('none');
        $line->getOptions()->getTitleTextStyle()->setColor('#696363');

        return $this->render('Report/index.html.twig', array(
            'hosts_high' => $hosts_high,
            'hosts_critical' => $hosts_critical,
            'detections_high' => $detections_high,
            'detections_critical' => $detections_critical,
            'uniques_high' => $uniques_high,
            'uniques_critical' => $uniques_critical,
            'old_high' => $old_high,
            'old_critical' => $old_critical,
            'new_high' => $new_high,
            'new_critical' => $new_critical,
            'new_highvd' => $new_highvd,
            'new_critvd' => $new_critvd,
            'new_openhighvd' => $new_openhighvd,
            'new_opencritvd' => $new_opencritvd,
            'month' => $month,
            'year' => $year,
            'piechart' => $line
        ));
    }

    /**
     * @Route("/report/view", name="reportView")
     */
    public function view()
    {
        $request = Request::createFromGlobals();
        $month = $request->get('month', 1);
        $year = $request->get('year', date("Y"));
        $severity = $request->get('severity', 0); // 0 va retourner une erreur

        // High
        if ($severity == 3)
        {
            $vulnerabilities = $this->getDoctrine() #new high vulnerabilities
                ->getRepository('App:Vulnerability')
                ->getNewHighsDetail($month, $year);
        }
        // Critical
        if ($severity == 4)
        {
            $vulnerabilities = $this->getDoctrine() #new critical vulnerabilities
                ->getRepository('App:Vulnerability')
                ->getNewCritsDetail($month, $year);
        }

        return $this->render('Report/view.html.twig', array(
            'vulnerabilities' => $vulnerabilities
        ));
    }
    /**
     * @Route("/report/viewdetailed", name="reportViewDetail")
     */
    public function viewdetailed()
    {
        $request = Request::createFromGlobals();
        $month = $request->get('month', 1);
        $year = $request->get('year', date("Y"));
        $severity = $request->get('severity', 0); // 0 va retourner une erreur

        // High
        if ($severity == 3)
        {
            $vd = $this->getDoctrine() #new high vulnerabilities
                ->getRepository('App:VulnerabilityDetected')
                ->getNewHighVD($month, $year);
        }
        // Critical
        if ($severity == 4)
        {
            $vd = $this->getDoctrine() #new critical vulnerabilities
                ->getRepository('App:VulnerabilityDetected')
                ->getNewCritVD($month, $year);
        }

        return $this->render('report/viewdetailed.html.twig', array(
            'vd' => $vd
        ));
    }
}
