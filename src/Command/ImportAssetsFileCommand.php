<?php

namespace App\Command;

use App\Entity\Asset;
use App\Entity\Systeme;
use App\Entity\Status;
use App\Entity\Vulnerability;
use App\Entity\VulnerabilityDetected;
use App\Service\ConvertCsvToArray;
use Symfony\Component\Console\Command\Command;
use Symfony\Bundle\FrameworkBundle\Command\ContainerAwareCommand;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\DomCrawler\Crawler;
use \Datetime;
use Symfony\Component\Console\Helper\ProgressBar;
use App\Entity\Detection;

class ImportAssetsFileCommand extends ContainerAwareCommand
{
    protected function configure()
    {
        $this
            ->setName('app:importAssetsFile')

            ->setDescription('This command import a file (csv format) containing a list of your Assets, coming from your CMDB, and load it in the database.')
            ->addArgument('filename', InputArgument::REQUIRED, 'The file name to load')
            ->setHelp('Execute the command follow by the path : php bin/console app:importAssets /home/user/file.csv')
        ;
    }

    /**
     * @param InputInterface $input
     * @param OutputInterface $output
     * @return int|null|void
     */
    protected function execute(InputInterface $input, OutputInterface $output)
    {
        // Showing when the script is launched
        $now = new \DateTime();
        $output->writeln('<comment>Start : ' . $now->format('d-m-Y G:i:s') . ' ---</comment>');

        // Importing CSV on DB via Doctrine ORM
        $this->import($input, $output);

        // Showing when the script is over
        $now = new \DateTime();
        $output->writeln('<comment>End : ' . $now->format('d-m-Y G:i:s') . ' ---</comment>');

    }


    protected function import(InputInterface $input, OutputInterface $output)
    {
        // Getting php array of data from CSV
        $data = $this->get($input, $output);

        // Getting doctrine manager
        $em = $this->getContainer()->get('doctrine')->getManager();

        // Turning off doctrine default logs queries for saving memory
        $em->getConnection()->getConfiguration()->setSQLLogger(null);

        // Define the size of record, the frequency for persisting the data and the current index of records
        $size = count($data);
        $batchSize = 10;
        $i = 1;

        // Starting progress
        $progress = new ProgressBar($output, $size);
        $progress->setFormat(' %current%/%max% [%bar%] %percent:3s%% %elapsed:6s%/%estimated:-6s% %memory:6s%');
        $progress->start();

        // Processing on each row of data
        foreach($data as $row) {

            if ((empty($em->getRepository('App:Asset')->findOneBy(['ip' => $row['Nom']]))) AND
                (empty($em->getRepository('App:Asset')->findOneBy(['fqdn' => $row['Nom']]))) )
            {
                $asset = new Asset();
                if (filter_var($row['Nom'], FILTER_VALIDATE_IP)) {
                    $asset->setIp($row['Nom']);
                }
                else {
                    $asset->setFqdn($row['Nom']);
                    $ipAdress = gethostbyname($row['Nom']);
                    if (filter_var($ipAdress, FILTER_VALIDATE_IP)) {
                        $asset->setIp($ipAdress);
                    }
                }
            }
            else
            {
                $asset = $em->getRepository('App:Asset')->findOneBy(['ip' => $row['Nom']]);
                if (empty($asset))
                {
                    $asset = $em->getRepository('App:Asset')->findOneBy(['fqdn' => $row['Nom']]);
                }
            }
            $asset->setName($row['Nom']);
            $asset->setDescription($row['Description']);

            $system = $em->getRepository('App:Systeme')->findOneBy(['name' => $row['Système']]);
            if (empty($system))
            {
                $system = new Systeme();
                $system->setName($row['Système']);
            }
            $em->persist($system);

            $asset->setSystem($system);
            $em->persist($asset);
            unset($asset);

            if (($i % $batchSize) === 0)
            {
                $em->flush();
                $em->clear();

                // Advancing for progress display on console
                $progress->advance($batchSize);
                $now = new \DateTime();
                $output->writeln(' of assets imported ... | ' . $now->format('d-m-Y G:i:s'));
            }

            $i++;

        }
        // Flushing and clear data on queue
        $em->flush();
        $em->clear();
        // Ending the progress bar process
        $progress->finish();
    }

    protected function get(InputInterface $input, OutputInterface $output)
    {
        if ($filename = $input->getArgument('filename'))
        {
            // Using service for converting CSV to PHP Array
            $converter = $this->getContainer()->get(ConvertCsvToArray::class);

            $data = $converter->convert($filename, ',');

            return $data;
        }
        else
        {
            exit(1);
        }
    }
}
