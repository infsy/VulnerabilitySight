<?php

namespace App\Command;

use App\Entity\Asset;
use App\Entity\Status;
use App\Entity\Vulnerability;
use App\Entity\VulnerabilityDetected;
use App\Entity\Detection;
use Symfony\Component\Console\Command\Command;
use Symfony\Bundle\FrameworkBundle\Command\ContainerAwareCommand;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\Serializer\Serializer;
use Symfony\Component\Serializer\Encoder\CsvEncoder;
use Symfony\Component\Serializer\Normalizer\ObjectNormalizer;
use \Datetime;
use Unirest;


class ScannerGetScanCommand extends ContainerAwareCommand
{
    protected function configure()
    {
        $this
            ->setName('app:ScannerGetScan')
            ->setDescription('This command synchronize 1 scan from the scanner')
            ->addArgument('scannerId', InputArgument::REQUIRED, 'The scan to process')
	    ->addArgument('scannerName', InputArgument::OPTIONAL, 'The scan name to process')
            ->setHelp('Get scan details from scanner and store them in the local database');
    }

    /**
     * @param InputInterface $input
     * @param OutputInterface $output
     * @return int|null|void
     */
    protected function execute(InputInterface $input, OutputInterface $output)
    {
        // initializing Container to work with Entities
        $em = $this->getContainer()->get('doctrine')->getManager();
        $em->getConnection()->getConfiguration()->setSQLLogger(null);

        // Connection to the API to retrieve session token
        $output->writeln('Connection to the API');
        $headers = array('Accept' => 'application/json');
        $data = array('username' => getenv('SCANNER_LOGIN'), 'password' => getenv('SCANNER_PASSWORD'));
        $body = Unirest\Request\Body::form($data);
        // We disable SSL verification
        Unirest\Request::verifyPeer(false);
        // We increase the Timeout
        Unirest\Request::timeout(18000);
        $response = Unirest\Request::post(getenv('SCANNER_SERVER') . '/session', $headers, $body);
        $token = $response->body->token;
        if (empty($token)) {
            $output->writeln('Session for ScannerGetScanCommand initialization failed');
        } else {
            $output->writeln('Session establishment succeed for ScannerGetScanCommand');
        }
        // The token is send in the defaultheader
        Unirest\Request::defaultHeader('X-Cookie', 'token=' . $token . '');

        $query = array('scan_id' => $input->getArgument('scannerId'));
        $responseScanDetails = Unirest\Request::get(getenv('SCANNER_SERVER') . '/scans/' . $input->getArgument('scannerId'), $headers, $query);
        if (!empty($responseScanDetails->body->info->hostcount)) {
            // We've got a scan filled with targets, we have to load it in the base
            $scan_start = intval($responseScanDetails->body->info->scan_start);
            $scan_start = new \DateTime("@$scan_start");
            $scan_start->setTime(0, 0, 0, 0);
            $detection = $em->getRepository('App:Detection')->findOneBy(
                ['sourceReference' => $input->getArgument('scannerId'),
                    'date_execution' => $scan_start]
            );

            // If this scan is not yet in the base we create it, otherwise we update it
            if (empty($detection)) {
                $detection = new Detection();
                $detection->setDateExecution($scan_start);
                $detection->setDateUpload(new \DateTime());
                $detection->setSourceName($input->getArgument('scanner'));
                $detection->setSourceReference(strval($input->getArgument('scannerId')));
                $detection->setMethod($responseScanDetails->body->info->policy);

                // We persist detection before to insert dependencies in the DB
                $em->persist($detection);
                $em->flush();

                // we load hosts and vulnerabilities found
                foreach ($responseScanDetails->body->hosts as $hostFromScan) {
                    $host = $em->getRepository('App:Asset')->findAssetByScan(
                        $input->getArgument('scannerId'), $hostFromScan->host_id);

                    if (empty($host)) {
                        //	Le host n'existe pas encore en DB on test si il existe via d'autres scan
                        $host = $em->getRepository('App:Asset')->findOneBy(
                            ["host_id" => $hostFromScan->host_id]
                        );
                        if (empty($host)) {
                            $host = new Asset();
                            $host->setHost_id($hostFromScan->host_id);
                        }
                        // Que ce soit un nouveau host ou un host non encore associÃ© on le connecte au scan en cours
                        $host->addDetection($detection);
                    }
                    $query = '';
                    $responseHostDetails = Unirest\Request::get(getenv('SCANNER_SERVER') . '/scans/' . $input->getArgument('scannerId') . '/hosts/' . $hostFromScan->host_id, $headers, $query);
                    if (!empty($responseHostDetails->body->info->{'host-ip'})) {
                        $host->setIp($responseHostDetails->body->info->{'host-ip'});
                    }
                    if (!empty($responseHostDetails->body->info->{'host-fqdn'})) {
                        $host->setFqdn($responseHostDetails->body->info->{'host-fqdn'});
                    }
                    $em->persist($host);

                    foreach ($responseHostDetails->body->vulnerabilities as $vulnerabilityFromScan) {
                        $vulnerability = $em->getRepository('App:Vulnerability')->findOneBy(
                            ["pluginId" => $vulnerabilityFromScan->plugin_id]
                        );
                        if (empty($vulnerability)) {
                            $vulnerability = new Vulnerability();
                            $vulnerability->SetPluginId($vulnerabilityFromScan->plugin_id);

                            $vulnerability->SetDescription($vulnerabilityFromScan->plugin_name);
                            $vulnerability->SetSeverity($vulnerabilityFromScan->severity);

                            $query = '';
                            $responsePluginDetails = Unirest\Request::get(getenv('SCANNER_SERVER') . '/scans/' . $input->getArgument('scannerId') . '/hosts/' . $hostFromScan->host_id . '/plugins/' . $vulnerabilityFromScan->plugin_id, $headers, $query);
                            $vulnerability->setSolution($responsePluginDetails->body->info->plugindescription->pluginattributes->solution);
                            $vulnerability->setDetails($responsePluginDetails->body->info->plugindescription->pluginattributes->description);
                            if (!empty($responsePluginDetails->body->outputs->plugin_output)) {
                                $vulnerability->SetOutput($responsePluginDetails->body->outputs->plugin_output);
                            }
                            $em->persist($vulnerability);
                        }
                        $vulnerabilityDetected = $em->getRepository('App:VulnerabilityDetected')->findOneInScan(
                            $host->getId(),
                            $detection->getId(),
                            $vulnerability->getId()
                        );
                        if (empty($vulnerabilityDetected)) {
                            $vulnerabilityDetected = $em->getRepository('App:VulnerabilityDetected')->findOneBy(
                                ["vulnerability" => $vulnerability,
                                    "asset" => $host]
                            );
                            if (empty($vulnerabilityDetected)) {
                                            $vulnerabilityDetected = new VulnerabilityDetected();
                                            $vulnerabilityDetected->setAsset($host);
                                            $vulnerabilityDetected->setVulnerability($vulnerability);
                                            $vulnerabilityDetected->setDate_Created($scan_start);
					                        $status = $em->getRepository('App:Status')->findOneBy(
                                            ["name" => "Open"]);
					                        if (!empty($status)) {
					                            $vulnerabilityDetected->setStatus($status);
					                        }
                                            $em->persist($vulnerabilityDetected);
                            }
                            $vulnerabilityDetected->setDate_Modified($scan_start);
                            $detection->addVulnerabilityDetected($vulnerabilityDetected);
                        }

                        $em->persist($detection);
					    $em->flush();
                    }
                    $em->flush();
                }
            }
        }
    }
}