<?php

namespace App\Command;

use Symfony\Component\Console\Command\Command;
use Symfony\Bundle\FrameworkBundle\Command\ContainerAwareCommand;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\DomCrawler\Crawler;
use \Datetime;

use App\Entity\Detection;

class ImportNessusFileCommand extends ContainerAwareCommand
{
    protected function configure()
    {
        $this
            ->setName('app:importNessusFile')

            ->setDescription('This command import a nessus file, resulting from a vulnerability scan, and load it in the database.')
            ->addArgument('filename', InputArgument::REQUIRED, 'The file name to load')
            ->setHelp('Execute the command follow by the path : php bin/console app:importNessus /home/user/file.nessus')
        ;
    }

    /**
     * @param InputInterface $input
     * @param OutputInterface $output
     * @return int|null|void
     */
    protected function execute(InputInterface $input, OutputInterface $output)
    {
        // initializing Container to work with Entities
        $em = $this->getContainer()->get('doctrine')->getManager();
        $em->getConnection()->getConfiguration()->setSQLLogger(null);

        // Loading of the XML file coming from Nessus
        $output->writeln('We analyze the file ' . $input->getArgument('filename') . ', please wait...');
        $crawler = new Crawler();
        $crawler->addXmlContent(file_get_contents($input->getArgument('filename')));

//
//        foreach ($crawler as $domElement) {
//            $output->writeln($domElement->nodeName);
//        }

        // Creating the source report if not already loaded
        $dateFromReport = explode(" ",
            $crawler->filterXPath('//Report/ReportHost/HostProperties/tag[contains(@name, "HOST_START")]')->text());
        $format = 'Y-M-d H:i:s';
        $dateFromReportObject = DateTime::createFromFormat(
            $format, $dateFromReport[4].'-'.$dateFromReport[1].'-'.$dateFromReport[2].' '.$dateFromReport[3]
        );
        $sourceReference = $crawler->filterXPath('//Report')->attr('name');

        $detection = $em->getRepository('App:Detection')->findOneBy([
            'date_execution' => $dateFromReportObject,
            'sourceReference' => $sourceReference,
        ]);
        if (empty($detection))
        {
            $detection = new Detection();
            $detection->setDateExecution($dateFromReportObject);
            $detection->setDateUpload(new \DateTime());
            $detection->setSourceName("Nessus scan");
            $detection->setSourceReference($sourceReference);
            $detection->setMethod($crawler->filterXPath('//Policy/policyName')->text());
            $em->persist($detection);
        }

        // We crawl every host tested in this scan
        $nodeValues = $crawler->filterXPath('//Report/ReportHost')->each(function (Crawler $node, $i) {
            $nodeElements['ip'] = $node->filterXPath('//HostProperties/tag[contains(@name, "host-ip")]')->text();
            $nodeElements['fqdn'] = $node->filterXPath('//HostProperties/tag[contains(@name, "fqdn")]')->text();
            $nodeElements['date_created'] = new \DateTime();
            $count = $node->filterXPath('//ReportItem')->count();
            var_dump($count);

            $nodeVuln = $node->filterXPath('//ReportItem')->first();
            $vulnerabilities = array();
//            var_dump($nodeVuln);

            while ($count --> 0) {
                if (($nodeVuln->attr('severity')) != 0) {
                    $vulnerabilityElements['port'] = $nodeVuln->filterXPath('//ReportItem')->attr('port');
                    $vulnerabilityElements['protocol'] = $nodeVuln->filterXPath('//ReportItem')->attr('protocol');
                    if (!empty($nodeVuln->filterXPath('//ReportItem/cve')->text())) {
                        $vulnerabilityElements['cve'] = $nodeVuln->filterXPath('//ReportItem/cve')->text();
                    }
                    if (!empty($nodeVuln->filterXPath('//ReportItem/cvss_base_score')->text())) {
                        $vulnerabilityElements['cvss'] = $nodeVuln->filterXPath('//ReportItem/cvss_base_score')->text();
                    }
                    $vulnerabilityElements['description'] = $nodeVuln->filterXPath('//ReportItem')->attr('pluginName');
                    $vulnerabilityElements['details'] = $nodeVuln->filterXPath('//ReportItem/description')->text();
                    $vulnerabilities[] = $vulnerabilityElements;
                }
                $nodeVuln = $node->filterXPath('//ReportItem')->nextAll();
            }
            $nodeElements['vulns'] = $vulnerabilities;



//                $vulnerabilities = array();
//            $vulnerabitiesValues = $node->filterXPath('//HostProperties/ReportItem')->each(function (Crawler $nodeVuln, $j) {
//                var_dump('catch 1');
//                if ($nodeVuln->filterXPath('//')->attr('severity') != 0) {
//                    $vulnerabilityElements['port'] = $nodeVuln->filterXPath('//')->attr('port');
//                    $vulnerabilityElements['protocol'] = $nodeVuln->filterXPath('//')->attr('protocol');
//                    if (!empty($nodeVuln->filterXPath('//cve')->text())) {
//                        $vulnerabilityElements['cve'] = $nodeVuln->filterXPath('//cve')->text();
//                    }
//                    if (!empty($nodeVuln->filterXPath('//cvss_base_score')->text())) {
//                        $vulnerabilityElements['cvss'] = $nodeVuln->filterXPath('//cvss_base_score')->text();
//                    }
//                    $vulnerabilityElements['description'] = $nodeVuln->filterXPath('//')->attr('pluginName');
//                    $vulnerabilityElements['details'] = $nodeVuln->filterXPath('//description')->text();
//                    $vulnerabilities[] = $vulnerabilityElements;
//                }
//                return $vulnerabilities;
//            });
//            $nodeElements['vulnerabilities'] = $vulnerabilities;
//            $nodeElements['vulnerabilities'] = $vulnerabitiesValues;

            return $nodeElements;
        });

        var_dump($nodeValues);
    }
}