<?php

namespace App\Command;

use App\Entity\Asset;
use App\Entity\Status;
use App\Entity\Vulnerability;
use App\Entity\VulnerabilityDetected;
use Symfony\Component\Console\Command\Command;
use Symfony\Bundle\FrameworkBundle\Command\ContainerAwareCommand;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\DomCrawler\Crawler;
use \Datetime;

use App\Entity\Detection;

class ImportNessusFileCommand extends ContainerAwareCommand
{
    protected function configure()
    {
        $this
            ->setName('app:importNessusFile')

            ->setDescription('This command import a nessus file, resulting from a vulnerability scan, and load it in the database.')
            ->addArgument('filename', InputArgument::REQUIRED, 'The file name to load')
            ->setHelp('Execute the command follow by the path : php bin/console app:importNessus /home/user/file.nessus')
        ;
    }

    /**
     * @param InputInterface $input
     * @param OutputInterface $output
     * @return int|null|void
     */
    protected function execute(InputInterface $input, OutputInterface $output)
    {
        // initializing Container to work with Entities
        $em = $this->getContainer()->get('doctrine')->getManager();
        $em->getConnection()->getConfiguration()->setSQLLogger(null);

        // Loading of the XML file coming from Nessus
        $output->writeln('We analyze the file ' . $input->getArgument('filename') . ', please wait...');
        $crawler = new Crawler();
        $crawler->addXmlContent(file_get_contents($input->getArgument('filename')));

//
//        foreach ($crawler as $domElement) {
//            $output->writeln($domElement->nodeName);
//        }

        // Creating the source report if not already loaded
        $dateFromReport = explode(" ",
            $crawler->filterXPath('//Report/ReportHost/HostProperties/tag[contains(@name, "HOST_START")]')->text());
        $format = 'Y-M-d H:i:s';
        $dateFromReportObject = DateTime::createFromFormat(
            $format, $dateFromReport[4].'-'.$dateFromReport[1].'-'.$dateFromReport[2].' '.$dateFromReport[3]
        );
        $sourceReference = $crawler->filterXPath('//Report')->attr('name');

        $detection = $em->getRepository('App:Detection')->findOneBy([
            'date_execution' => $dateFromReportObject,
            'sourceReference' => $sourceReference,
        ]);
        if (empty($detection))
        {
            $detection = new Detection();
            $detection->setDateExecution($dateFromReportObject);
            $detection->setDateUpload(new \DateTime());
            $detection->setSourceName("Nessus scan");
            $detection->setSourceReference($sourceReference);
            $detection->setMethod($crawler->filterXPath('//Policy/policyName')->text());
            $em->persist($detection);
            $em->flush();
        }

            // We crawl every host tested in this scan
        if ( file_exists( $input->getArgument('filename') ) ) {
            // Get XML object
            $xml_object = simplexml_load_file( $input->getArgument('filename') );
            foreach ($xml_object->xpath('//ReportHost') as $host)
            {
                foreach ($host->HostProperties->tag as $tag)
                {
                    if ($tag['name'] == 'host-ip')
                    {
                        $hostIp = (string)$tag;
                    }
                    if ($tag['name'] == 'host-fqdn')
                    {
                        $hostFqdn = (string)$tag;
                    }
                }
                if ((empty($em->getRepository('App:Asset')->findOneBy(['ip' => $hostIp]))) AND
                    (empty($em->getRepository('App:Asset')->findOneBy(['fqdn' => $hostFqdn]))) )
                {
                    $asset = new Asset();
                    if (!empty($hostFqdn))
                    {
                        $asset->setFqdn($hostFqdn);
                    }
                    $asset->setIp($hostIp);
                    $em->persist($asset);
                    $em->flush();
                }
                else
                {
                    $asset = $em->getRepository('App:Asset')->findOneBy(['ip' => $hostIp]);
                    if (empty($asset))
                    {
                        $asset = $em->getRepository('App:Asset')->findOneBy(['fqdn' => $hostFqdn]);
                    }
                }

                foreach ($host->ReportItem as $vuln)
                {

                    if ((string)$vuln['severity'] != '0')
                    {
                        if (empty($em->getRepository('App:Vulnerability')->findOneBy(['pluginId' => $vuln['pluginID']]))) {
                            $vulnerability = new Vulnerability();
                            $vulnerability->setSeverity((integer)$vuln['severity']);
                            $pluginName = str_replace("'", " ",$vuln['pluginName']);
//                            $vulnerability->setDescription((string)$pluginName);
                            $vulnerability->setDescription((string)"Test description");
                            $description=str_replace("\n", "", $vuln->description);
                            $description=str_replace("'", " ",$description);
//                            $vulnerability->setDetails((string)$description);
                            $vulnerability->setDetails((string)"Test Details");
                            $vulnerability->setPluginId((integer)$vuln['pluginID']);
                            if (!empty($vuln->cvss3_base_score))
                            {
                                $vulnerability->setCvss((float)$vuln->cvss3_base_score);
                            }
                            elseif (!empty($vuln->cvss_base_score))
                            {
                                $vulnerability->setCvss((float)$vuln->cvss_base_score);
                            }
                            if (!empty($vuln->solution))
                            {
                                $vulnerability->setSolution((string)$vuln->solution);
                            }
                            if (!empty($vuln->see_also))
                            {
//                                $vulnerability->setReferences((string)$vuln->see_also);
                                $vulnerability->setReferences((string)"Test See also");
                            }
                            if (!empty($vuln->plugin_output))
                            {
                                $pluginOutput = str_replace("'", " ",$vuln->plugin_output);
//                                $vulnerability->setOutput((string)$pluginOutput);
                                $vulnerability->setOutput((string)"Test output");
                            }

                            $em->persist($vulnerability);
                            $em->flush();
                        }
                        $vulnDetected = $em->getRepository('App:VulnerabilityDetected')->findBy([
                            'vulnerability' => $vulnerability,
                            'asset' => $asset
                        ]);
                        $alreadyExist = false;
                        foreach ($vulnDetected as $vulnOccured)
                        {
                            if (empty($vulnOccured->getDate_closed))
                            {
                                $alreadyExist = true;
                            }
                        }
                        if (!$alreadyExist)
                        {
                            $vulnDetected = new VulnerabilityDetected();
                            $vulnDetected->setDateCreated(new \DateTime());
                            $vulnDetected->setPort($vuln['port']);
                            $vulnDetected->setProtocol($vuln['protocol']);
                            $vulnDetected->setVulnerability($vulnerability);
                            $vulnDetected->setAsset($asset);
                            $vulnDetected->setDetection($detection);
                            $status = $em->getRepository('App:Status')->findOneBy([
                                'name' => 'Open'
                            ]);
                            if (empty($status))
                            {
                                $status = new Status();
                                $status->setName('Open');
                                $em->persist($status);
                                $em->flush();
                            }
                            $vulnDetected->setStatus($status);
                            $em->persist($vulnDetected);
                        }
                    }
                }
            }
            $em->flush();

        }

    }

}