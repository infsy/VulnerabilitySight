<?php

namespace App\Command;

use App\Entity\Asset;
use App\Entity\Status;
use App\Entity\Vulnerability;
use App\Entity\VulnerabilityDetected;
use Symfony\Component\Console\Command\Command;
use Symfony\Bundle\FrameworkBundle\Command\ContainerAwareCommand;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\DomCrawler\Crawler;
use \Datetime;

use App\Entity\Detection;

class ImportAssetsFileCommand extends ContainerAwareCommand
{
    protected function configure()
    {
        $this
            ->setName('app:importAssetsFile')

            ->setDescription('This command import a file (csv format) containing a list of your Assets, coming from your CMDB, and load it in the database.')
            ->addArgument('filename', InputArgument::REQUIRED, 'The file name to load')
            ->setHelp('Execute the command follow by the path : php bin/console app:importAssets /home/user/file.csv')
        ;
    }

    /**
     * @param InputInterface $input
     * @param OutputInterface $output
     * @return int|null|void
     */
    protected function execute(InputInterface $input, OutputInterface $output)
    {
        // Showing when the script is launched
        $now = new \DateTime();
        $output->writeln('<comment>Start : ' . $now->format('d-m-Y G:i:s') . ' ---</comment>');

        // Importing CSV on DB via Doctrine ORM
        $this->import($input, $output);

        // Showing when the script is over
        $now = new \DateTime();
        $output->writeln('<comment>End : ' . $now->format('d-m-Y G:i:s') . ' ---</comment>');

        // initializing Container to work with Entities
        $em = $this->getContainer()->get('doctrine')->getManager();
        $em->getConnection()->getConfiguration()->setSQLLogger(null);

        // Loading of the XML file coming from Nessus
        $output->writeln('We analyze the file ' . $input->getArgument('filename') . ', please wait...');
        $crawler = new Crawler();
        $crawler->addXmlContent(file_get_contents($input->getArgument('filename')));

//
//        foreach ($crawler as $domElement) {
//            $output->writeln($domElement->nodeName);
//        }

        // Creating the source report if not already loaded
        $dateFromReport = explode(" ",
            $crawler->filterXPath('//Report/ReportHost/HostProperties/tag[contains(@name, "HOST_START")]')->text());
        $format = 'Y-M-d H:i:s';
        $dateFromReportObject = DateTime::createFromFormat(
            $format, $dateFromReport[4].'-'.$dateFromReport[1].'-'.$dateFromReport[2].' '.$dateFromReport[3]
        );
        $sourceReference = $crawler->filterXPath('//Report')->attr('name');

        $detection = $em->getRepository('App:Detection')->findOneBy([
            'date_execution' => $dateFromReportObject,
            'sourceReference' => $sourceReference,
        ]);
        if (empty($detection))
        {
            $detection = new Detection();
            $detection->setDateExecution($dateFromReportObject);
            $detection->setDateUpload(new \DateTime());
            $detection->setSourceName("Nessus scan");
            $detection->setSourceReference($sourceReference);
            $detection->setMethod($crawler->filterXPath('//Policy/policyName')->text());
            $em->persist($detection);
            $em->flush();
        }

            // We crawl every host tested in this scan
        if ( file_exists( $input->getArgument('filename') ) ) {
            // Get XML object
            $xml_object = simplexml_load_file( $input->getArgument('filename') );
            foreach ($xml_object->xpath('//ReportHost') as $host)
            {
                foreach ($host->HostProperties->tag as $tag)
                {
                    if ($tag['name'] == 'host-ip')
                    {
                        $hostIp = (string)$tag;
                    }
                    if ($tag['name'] == 'host-fqdn')
                    {
                        $hostFqdn = (string)$tag;
                    }
                }
                if ((empty($em->getRepository('App:Asset')->findOneBy(['ip' => $hostIp]))) AND
                    (empty($em->getRepository('App:Asset')->findOneBy(['fqdn' => $hostFqdn]))) )
                {
                    $asset = new Asset();
                    if (!empty($hostFqdn))
                    {
                        $asset->setFqdn($hostFqdn);
                    }
                    $asset->setIp($hostIp);
                    $em->persist($asset);
                    $em->flush();
                }
                else
                {
                    $asset = $em->getRepository('App:Asset')->findOneBy(['ip' => $hostIp]);
                    if (empty($asset))
                    {
                        $asset = $em->getRepository('App:Asset')->findOneBy(['fqdn' => $hostFqdn]);
                    }
                }

                foreach ($host->ReportItem as $vuln)
                {

                    if ((string)$vuln['severity'] != '0')
                    {
                        if (empty($em->getRepository('App:Vulnerability')->findOneBy(['pluginId' => $vuln['pluginID']]))) {
                            $vulnerability = new Vulnerability();
                            $vulnerability->setSeverity((integer)$vuln['severity']);
                            $pluginName = str_replace("'", " ",$vuln['pluginName']);
//                            $vulnerability->setDescription((string)$pluginName);
                            $vulnerability->setDescription((string)"Test description");
                            $description=str_replace("\n", "", $vuln->description);
                            $description=str_replace("'", " ",$description);
//                            $vulnerability->setDetails((string)$description);
                            $vulnerability->setDetails((string)"Test Details");
                            $vulnerability->setPluginId((integer)$vuln['pluginID']);
                            if (!empty($vuln->cvss3_base_score))
                            {
                                $vulnerability->setCvss((float)$vuln->cvss3_base_score);
                            }
                            elseif (!empty($vuln->cvss_base_score))
                            {
                                $vulnerability->setCvss((float)$vuln->cvss_base_score);
                            }
                            if (!empty($vuln->solution))
                            {
                                $vulnerability->setSolution((string)$vuln->solution);
                            }
                            if (!empty($vuln->see_also))
                            {
//                                $vulnerability->setReferences((string)$vuln->see_also);
                                $vulnerability->setReferences((string)"Test See also");
                            }
                            if (!empty($vuln->plugin_output))
                            {
                                $pluginOutput = str_replace("'", " ",$vuln->plugin_output);
//                                $vulnerability->setOutput((string)$pluginOutput);
                                $vulnerability->setOutput((string)"Test output");
                            }

                            $em->persist($vulnerability);
                            $em->flush();
                        }
                        $vulnDetected = $em->getRepository('App:VulnerabilityDetected')->findBy([
                            'vulnerability' => $vulnerability,
                            'asset' => $asset
                        ]);
                        $alreadyExist = false;
                        foreach ($vulnDetected as $vulnOccured)
                        {
                            if (empty($vulnOccured->getDate_closed))
                            {
                                $alreadyExist = true;
                            }
                        }
                        if (!$alreadyExist)
                        {
                            $vulnDetected = new VulnerabilityDetected();
                            $vulnDetected->setDateCreated(new \DateTime());
                            $vulnDetected->setPort($vuln['port']);
                            $vulnDetected->setProtocol($vuln['protocol']);
                            $vulnDetected->setVulnerability($vulnerability);
                            $vulnDetected->setAsset($asset);
                            $vulnDetected->setDetection($detection);
                            $status = $em->getRepository('App:Status')->findOneBy([
                                'name' => 'Open'
                            ]);
                            if (empty($status))
                            {
                                $status = new Status();
                                $status->setName('Open');
                                $em->persist($status);
                                $em->flush();
                            }
                            $vulnDetected->setStatus($status);
                            $em->persist($vulnDetected);
                        }
                    }
                }
            }
            $em->flush();

        }

    }
    protected function import(InputInterface $input, OutputInterface $output)
    {
        // Getting php array of data from CSV
        $data = $this->get($input, $output);

        // Getting doctrine manager
        $em = $this->getContainer()->get('doctrine')->getManager();

        // Turning off doctrine default logs queries for saving memory
        $em->getConnection()->getConfiguration()->setSQLLogger(null);

        // Define the size of record, the frequency for persisting the data and the current index of records
        $size = count($data);
        $batchSize = 10;
        $i = 1;

        // Starting progress
        $progress = new ProgressBar($output, $size);
        $progress->start();

        // Processing on each row of data
        foreach($data as $row) {

            if ((empty($em->getRepository('App:Asset')->findOneBy(['ip' => $row['asset']]))) AND
                (empty($em->getRepository('App:Asset')->findOneBy(['fqdn' => $row['asset']]))) )
            {
                $asset = new Asset();
                if (filter_var($row['asset'], FILTER_VALIDATE_IP)) {
                    $asset->setIp($row['asset']);
                }
                else {
                    $asset->setFqdn($row['asset']);
                    $ipAdress = gethostbyname($row['asset']);
                    if (filter_var($ipAdress, FILTER_VALIDATE_IP)) {
                        $asset->setIp($ipAdress);
                    }
                }
                $asset->setName($row['name']);

            }
            else
            {
                $asset = $em->getRepository('App:Asset')->findOneBy(['ip' => $row['asset']]);
                if (empty($asset))
                {
                    $asset = $em->getRepository('App:Asset')->findOneBy(['fqdn' => $row['asset']]);
                }
            }
                if (!empty($hostFqdn))
                {
                    $asset->setFqdn($hostFqdn);
                }
                $asset->setIp($hostIp);
                $em->persist($asset);
            $asset = $em->getRepository('App:Asset')
                ->findOneByName($row['Nom'], $row['Prénom']);
            if(!is_object($conseiller)){
                $output->writeln('<comment>Conseiller inconnu : ' . $row['Nom'] . ' ' . $row['Prénom'] . ' ---</comment>');
            }
            else
            {
                $mandat = $em->getRepository('NurunRhBundle:Mandat')
                    ->findOneByIdentifiant($row['Contrat']);
                if (empty($mandat))
                {
                    $output->writeln('<error>Le mandat '. $row['Contrat']. ' ne se trouve pas, on le créé</error>');
                    $mandat = new Mandat();
                    $mandat->setChargeprojet($boss);
                    $mandat->setMandataire($boss);
                    $mandat->setClient($nurun);
                    $mandat->setDateFin(new \DateTime());
                    $mandat->setIdentifiant($row['Contrat']);
                    $mandat->setNbreHeures(37.5);
                    $mandat->setSecteur('VPSI');
                    $mandat->setTitre('A definir');
                    $mandat->setOffre('Solutions informatique');
                    $mandat->setType('H');
                    $em->persist($mandat);

                }

                $statut = $em->getRepository('NurunRhBundle:StatutAffectation')
                    ->findOneByAcronyme($row['Statut']);
                if (empty($statut))
                {
                    $output->writeln('<error>Le statut '. $row['Statut']. ' ne se trouve pas</error>');
                }


                $affectation = new ConseillerMandat();
                $affectation->setConseiller($conseiller);
                $affectation->setDateDebut(new \DateTime($row['Date début']));
                $affectation->setDateFin(new \DateTime($row['Date fin']));
                $affectation->setMandat($mandat);
                $affectation->setPourcentage($row['%']);
                $affectation->setStatutAffectation($statut);

                $em->persist($affectation);

                unset($affectation);
                unset($conseiller);
                unset($mandat);
                unset($statut);
            }

            if (($i % $batchSize) === 0)
            {
                $em->flush();
                $em->clear();

                // Advancing for progress display on console
                $progress->advance($batchSize);
                $now = new \DateTime();
                $output->writeln(' of affectations imported ... | ' . $now->format('d-m-Y G:i:s'));
            }

            $i++;

        }
        // Flushing and clear data on queue
        $em->flush();
        $em->clear();
        // Ending the progress bar process
        $progress->finish();
    }

    protected function get(InputInterface $input, OutputInterface $output)
    {
        if ($filename = $input->getArgument('file'))
        {
            // Using service for converting CSV to PHP Array
            $converter = $this->getContainer()->get('import.csvtoarray');
            $data = $converter->convert($filename, ',');

            return $data;
        }
        else
        {
            exit(1);
        }
    }
}