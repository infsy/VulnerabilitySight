<?php

namespace App\Repository;

use App\Entity\Vulnerability;
use Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository;
use Symfony\Bridge\Doctrine\RegistryInterface;

class VulnerabilityRepository extends ServiceEntityRepository
{
    public function __construct(RegistryInterface $registry)
    {
        parent::__construct($registry, Vulnerability::class);
    }

    /*
    public function findBySomething($value)
    {
        return $this->createQueryBuilder('v')
            ->where('v.something = :value')->setParameter('value', $value)
            ->orderBy('v.id', 'ASC')
            ->setMaxResults(10)
            ->getQuery()
            ->getResult()
        ;
    }
    */

    // Number of unique high vulnerabilities for given month
    public function getUniqueHighs($month, $year)
    {
        $targetStart = "$year-$month-01"; // Date start of range
        $targetEnd = "$year-$month-31"; // Date end of range

        $qb = $this->createQueryBuilder('v');
         $qb->innerjoin('v.vulnerabilitiesDetected', 'vd')
            ->innerjoin('vd.detections', 'd')
            ->where('d.date_execution >= :execStart')
            ->andWhere('d.date_execution <= :execEnd')
            ->andWhere('v.cvss > :cvss')
    		->andWhere('v.cvss <= :cvss2')
            ->setParameter('cvss', '6')
            ->setParameter('cvss2', '8')
            ->setParameter('execStart', $targetStart)
            ->setParameter('execEnd', $targetEnd);

        $uniqueHighs = $qb
            ->distinct(true)
            ->getQuery()
            ->getScalarResult();
        return count($uniqueHighs);
    }

    // Number of unique critical vulnerabilities for given month
    public function getUniqueCrits($month, $year)
    {
        $targetStart = "$year-$month-01"; // Date start of range
        $targetEnd = "$year-$month-31"; // Date end of range

        $qb = $this->createQueryBuilder('v');
         $qb->innerjoin('v.vulnerabilitiesDetected', 'vd')
            ->innerjoin('vd.detections', 'd')
            ->where('d.date_execution >= :execStart')
            ->andWhere('d.date_execution <= :execEnd')
            ->andWhere('v.cvss > :cvss')
            ->setParameter('cvss', '8')
            ->setParameter('execStart', $targetStart)
            ->setParameter('execEnd', $targetEnd);

        $uniqueCrits = $qb
            ->distinct(true)
            ->getQuery()
            ->getScalarResult();
        return count($uniqueCrits);
    }

    // Number of unique high vulnerabilities for given month
    // Only shows vulnerabilities older than 1 year. (Published at least
    // 1 year ago).
    public function getOldHighs($month, $year)
    {
        $targetStart = "$year-$month-01"; // Date start of range
        $targetEnd = "$year-$month-31"; // Date end of range
        $oldBaseline = ($year - 1) . "-0$month-01"; // Vulnerability detected at least 1 year after it was published
                                                   // Ex.: It's Febuary 2018, vulnerability is published in June 2015.
                                                   // oldBaseline is Febuary 2017. June 2015 < Febuary 2017 = True.
                                                   // So that vulnerability would be at least 1 year old, based on
                                                   // detection date.

        $qb = $this->createQueryBuilder('v');
         $qb->innerjoin('v.vulnerabilitiesDetected', 'vd')
            ->innerjoin('vd.detections', 'd')
            ->where('d.date_execution >= :execStart')
            ->andWhere('d.date_execution <= :execEnd')
            ->andWhere('v.cvss > :cvss')
    		->andWhere('v.cvss <= :cvss2')
    		->andWhere('v.publicationDate < :oldDate')
            ->setParameter('cvss', '6')
            ->setParameter('cvss2', '8')
            ->setParameter('oldDate', $oldBaseline)
            ->setParameter('execStart', $targetStart)
            ->setParameter('execEnd', $targetEnd);

        $oldHighs = $qb
            ->distinct(true)
            ->getQuery()
            ->getScalarResult();
        return count($oldHighs);
    }

    // Number of unique critical vulnerabilities for given month
    // Only shows vulnerabilities older than 1 year. (Published at least
    // 1 year ago).
    public function getOldCrits($month, $year)
    {
        $targetStart = "$year-$month-01"; // Date start of range
        $targetEnd = "$year-$month-31"; // Date end of range
        $oldBaseline = ($year - 1) . "-0$month-01"; // Vulnerability detected at least 1 year after it was published
                                                    // Ex.: It's Febuary 2018, vulnerability is published in June 2015.
                                                    // oldBaseline is Febuary 2017. June 2015 < Febuary 2017 = True.
                                                    // So that vulnerability would be at least 1 year old, based on
                                                    // detection date.

        $qb = $this->createQueryBuilder('v');
         $qb->innerjoin('v.vulnerabilitiesDetected', 'vd')
            ->innerjoin('vd.detections', 'd')
            ->where('d.date_execution >= :execStart')
            ->andWhere('d.date_execution <= :execEnd')
            ->andWhere('v.cvss > :cvss')
    		->andWhere('v.publicationDate < :oldDate')
            ->setParameter('cvss', '8')
            ->setParameter('oldDate', $oldBaseline)
            ->setParameter('execStart', $targetStart)
            ->setParameter('execEnd', $targetEnd);

        $oldCrits = $qb
            ->distinct(true)
            ->getQuery()
            ->getScalarResult();
        return count($oldCrits);
    }

    // Number of new unique high vulnerabilities for given month
    // Based off the previous month.
    public function getNewHighs($month, $year)
    {
        $targetStart = "$year-$month-01"; // Date start of range
        $targetEnd = "$year-$month-31"; // Date end of range

        // Previous month date calculation
        if ($month == 1)
        {
            $month = 12;
            $year--;
        }
        else
        {
            $month--;
        }
        $previousStart = "$year-$month-01"; // Date start of previous month
        $previousEnd = "$year-$month-31"; // Date end of previous month

        // Current/target month
        $qb = $this->createQueryBuilder('v');
         $qb->innerjoin('v.vulnerabilitiesDetected', 'vd')
            ->innerjoin('vd.detections', 'd')
            ->where('d.date_execution >= :execStart')
            ->andWhere('d.date_execution <= :execEnd')
            ->andWhere('v.cvss > :cvss')
    		->andWhere('v.cvss <= :cvss2')
            ->setParameter('cvss', '6')
            ->setParameter('cvss2', '8')
            ->setParameter('execStart', $targetStart)
            ->setParameter('execEnd', $targetEnd);

        $uniqueHighs = $qb
            ->distinct(true)
            ->getQuery()
            ->getScalarResult();

        // Previous month
        $qb = $this->createQueryBuilder('v');
         $qb->innerjoin('v.vulnerabilitiesDetected', 'vd')
            ->innerjoin('vd.detections', 'd')
            ->where('d.date_execution >= :execStart')
            ->andWhere('d.date_execution <= :execEnd')
            ->andWhere('v.cvss > :cvss')
    		->andWhere('v.cvss <= :cvss2')
            ->setParameter('cvss', '6')
            ->setParameter('cvss2', '8')
            ->setParameter('execStart', $previousStart)
            ->setParameter('execEnd', $previousEnd);

        $previousHighs = $qb
            ->distinct(true)
            ->getQuery()
            ->getScalarResult();

        $merge = array_merge($uniqueHighs, $previousHighs); // Full merge including duplicates
        $merge = array_unique($merge, $sort_flags = SORT_REGULAR); // Remove duplicates => A ∪ B
        $merge = count($merge); // Returns count of A ∪ B, as AB
        $merge = $merge - count($previousHighs); // AB - A = New vulnerabilities
        return $merge;
    }

    // Number of new unique critical vulnerabilities for given month
    // Based off the previous month.
    public function getNewCrits($month, $year)
    {
        $targetStart = "$year-$month-01"; // Date start of range
        $targetEnd = "$year-$month-31"; // Date end of range

        // Previous month date calculation
        if ($month == 1)
        {
            $month = 12;
            $year--;
        }
        else
        {
            $month--;
        }
        $previousStart = "$year-$month-01"; // Date start of previous month
        $previousEnd = "$year-$month-31"; // Date end of previous month

        // Current/target month
        $qb = $this->createQueryBuilder('v');
         $qb->innerjoin('v.vulnerabilitiesDetected', 'vd')
            ->innerjoin('vd.detections', 'd')
            ->where('d.date_execution >= :execStart')
            ->andWhere('d.date_execution <= :execEnd')
            ->andWhere('v.cvss > :cvss')
            ->setParameter('cvss', '8')
            ->setParameter('execStart', $targetStart)
            ->setParameter('execEnd', $targetEnd);

        $uniqueCrits = $qb
            ->distinct(true)
            ->getQuery()
            ->getScalarResult();

        // Previous month
        $qb = $this->createQueryBuilder('v');
         $qb->innerjoin('v.vulnerabilitiesDetected', 'vd')
            ->innerjoin('vd.detections', 'd')
            ->where('d.date_execution >= :execStart')
            ->andWhere('d.date_execution <= :execEnd')
            ->andWhere('v.cvss > :cvss')
            ->setParameter('cvss', '8')
            ->setParameter('execStart', $previousStart)
            ->setParameter('execEnd', $previousEnd);

        $previousCrits = $qb
            ->distinct(true)
            ->getQuery()
            ->getScalarResult();

        $merge = array_merge($uniqueCrits, $previousCrits); // Full merge including duplicates
        $merge = array_unique($merge, $sort_flags = SORT_REGULAR); // Remove duplicates => A ∪ B
        $merge = count($merge); // Returns count of A ∪ B, as AB
        $merge = $merge - count($previousCrits); // AB - A = New vulnerabilities
        return $merge;
    }
}
