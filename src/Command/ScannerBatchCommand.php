<?php

namespace App\Command;

use App\Entity\Asset;
use App\Entity\Status;
use App\Entity\Vulnerability;
use App\Entity\VulnerabilityDetected;
use App\Entity\Detection;
use Symfony\Component\Console\Command\Command;
use Symfony\Bundle\FrameworkBundle\Command\ContainerAwareCommand;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\Serializer\Serializer;
use Symfony\Component\Serializer\Encoder\CsvEncoder;
use Symfony\Component\Serializer\Normalizer\ObjectNormalizer;
use \Datetime;
use Unirest;


class ScannerBatchCommand extends ContainerAwareCommand
{
    protected function configure()
    {
        $this
            ->setName('app:ScannerBatch')
            ->setDescription('This command synchronize scans from the scanner')
            ->setHelp('Get all scan details from scanner and store them in the local database');
    }

    /**
     * @param InputInterface $input
     * @param OutputInterface $output
     * @return int|null|void
     */
    protected function execute(InputInterface $input, OutputInterface $output)
    {
        // initializing Container to work with Entities
        $em = $this->getContainer()->get('doctrine')->getManager();
        $em->getConnection()->getConfiguration()->setSQLLogger(null);

        // Connection to the API to retrieve session token
        $output->writeln('Connection to the API');
        $headers = array('Accept' => 'application/json');
        $data = array('username' => getenv('SCANNER_LOGIN'), 'password' => getenv('SCANNER_PASSWORD'));
        $body = Unirest\Request\Body::form($data);
        // We disable SSL verification
        Unirest\Request::verifyPeer(false);
        $response = Unirest\Request::post(getenv('SCANNER_SERVER') . '/session', $headers, $body);
        $token = $response->body->token;
        if (empty($token)) {
            $output->writeln('Session initialization failed');
        } else {
            $output->writeln('Session establishment succeed');
        }
        // The token is send in the defaultheader
        Unirest\Request::defaultHeader('X-Cookie', 'token=' . $token . '');

        // We retrieve the Folder list with the session token
        $response = Unirest\Request::get(getenv('SCANNER_SERVER') . '/folders', $headers, '');

        // We export data to csv file
        $serializer = new Serializer([new ObjectNormalizer()], [new CsvEncoder()]);
        $csvData = array(array('Folder', 'ScanName', 'Planification', 'LastExecution', 'Targets', 'NbreTargets'));

        foreach ($response->body->folders as $folder) {
            $output->writeln('Folder ' . $folder->name . ' is processed');
            $query = array('folder_id' => $folder->id);
            $responseScans = Unirest\Request::get(getenv('SCANNER_SERVER') . '/scans', $headers, $query);
            $output->writeln(count($responseScans->body->scans) . ' scans in this Folder');
            if (!empty($responseScans->body->scans)) {
                foreach ($responseScans->body->scans as $scan) {
                    $query = array('scan_id' => $scan->id);
                    $responseScanDetails = Unirest\Request::get(getenv('SCANNER_SERVER') . '/scans/' . $scan->id, $headers, $query);
                    if (!empty($responseScanDetails->body->info->hostcount)) {
                        // We've got a scan filled with targets, we have to load it in the base
                        $scan_start = intval($responseScanDetails->body->info->scan_start);
                        $scan_start = new \DateTime("@$scan_start");
                        $scan_start->setTime(0, 0, 0, 0);
                        $detection = $em->getRepository('App:Detection')->findOneBy(
                            ['sourceReference' => $scan->id,
                                'date_execution' => $scan_start]
                        );

                        // If this scan is not yet in the base we create it, otherwise we update it
                        $newScan = False;
                        if (empty($detection)) {
                            $detection = new Detection();
                            $newScan = True;
                        }
                        $detection->setDateExecution($scan_start);
                        $detection->setDateUpload(new \DateTime());
                        $detection->setSourceName($scan->name);
                        $detection->setSourceReference(strval($scan->id));
                        $detection->setMethod($responseScanDetails->body->info->policy);

                        $em->persist($detection);
                        $em->flush();

                        // if this is a new scan we load hosts and vulnerabilities found
                        if ($newScan) {
                            foreach ($responseScanDetails->body->hosts as $hostFromScan) {
                                $host = $em->getRepository('App:Asset')->findAssetByScan(
                                    $scan->id, $hostFromScan->host_id);

                                if (empty($host)) {
                                    //	$output->writeln('on ne trouve pas l asset');
                                    $host = $em->getRepository('App:Asset')->findOneBy(
                                        ["host_id" => $hostFromScan->host_id]
                                    );
                                    if (empty($host)) {
                                        $host = new Asset();
                                        $host->setHost_id($hostFromScan->host_id);
                                    }
                                    $host->addDetection($detection);
                                }
                                $query = '';
                                $responseHostDetails = Unirest\Request::get(getenv('SCANNER_SERVER') . '/scans/' . $scan->id . '/hosts/' . $hostFromScan->host_id, $headers, $query);
                                if (!empty($responseHostDetails->body->info->host - ip)) {
                                    $host->setIp($responseHostDetails->body->info->host - ip);
                                }
                                if (!empty($responseHostDetails->body->info->host - fqdn)) {
                                    $host->setFqdn($responseHostDetails->body->info->host - fqdn);
                                }
                                foreach ($responseHostDetails->body->info->vulnerabilities as $vulnerabilityFromScan) {
                                    $vulnerability = $em->getRepository('App:Vulnerability')->findOneBy(
                                        ["pluginid" => $vulnerabilityFromScan->plugin_id]
                                    );
                                    if (empty($vulnerability)) {
                                        $vulnerability = new Vulnerability();
                                        $vulnerability->SetPluginid($vulnerabilityFromScan->plugin_id);
                                    }
                                    $vulnerability->SetDescription($vulnerabilityFromSCan->plugin_name);
                                    $vulnerability->SetSeverity($vulnerabilityFromSCan->severity);

                                    $query = '';
                                    $responsePluginDetails = Unirest\Request::get(getenv('SCANNER_SERVER') . '/scans/' . $scan->id . '/hosts/' . $hostFromScan->host_id . '/plugins/' . $vulnerabilityFromScan->plugin_id, $headers, $query);
                                    $vulnerability->setSolution($responsePluginDetails->body->info->plugindescription->pluginattributes->solution);
                                    $vulnerability->setDetails($responsePluginDetails->body->info->plugindescription->pluginattributes->description);
                                    $vulnerability->SetOutput($responsePluginDetails->body->info->plugindescription->pluginattributes->output->plugin_output);
                                    $vulnerabilityDetected = $em->getRepository('App:VulnerabilityDetected')->findOneInScan(
                                        $host->getId(),
                                        $detection->getId(),
                                        $vulnerability->getId()
                                    );
                                    if (empty($vulnerabilityDetected)) {
                                        $vulnerabilityDetected = $em->getRepository('App:VulnerabilityDetected')->findOneBy(
                                            ["vulnerability" => $vulnerability,
                                                "asset" => $host]
                                        );
                                        if (empty($vulnerabilityDetected)) {
                                            $vulnerabilityDetected = new VulnerabilityDetected();
                                            $vulnerabilityDetected->setAsset($host);
                                            $vulnerabilityDetected->setVulnerability($vulnerability);
                                            $vulnerabilityDetected->setDate_created($scan_start);
                                        }
                                        $detection->addVulnerabilityDetected($vulnerabilityDetected);
                                        $vulnerabilityDetected->setDate_modified($scan_start);
                                        $em->persist($vulnerabilityDetected);
                                    }
                                }

                                $em->persist($host);
                                $em->flush();
                            }
                        }
                    }
                }
            }
        }
    }
}
